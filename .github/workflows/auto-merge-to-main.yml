name: Auto-merge devel to main

on:
    workflow_run:
        workflows: ["R-CMD-check.yaml"]
        branches: [devel]
        types: [completed]

permissions:
    contents: write
    pull-requests: write
    actions: read

jobs:
    auto-merge:
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest
        steps:
            - name: Checkout devel
              uses: actions/checkout@v5
              with:
                  ref: devel
                  fetch-depth: 0

            - name: Create or reuse PR devel â†’ main (if devel is ahead)
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  set -euo pipefail

                  # make sure we have both branches
                  git fetch origin main:main devel:devel

                  # only create a PR if devel has commits not in main
                  if [ "$(git rev-list --right-only --count main...devel)" -gt 0 ]; then
                    # try to find an open PR from devel to main
                    if gh pr list --base main --head devel --state open --json number --jq '.[0].number' >/dev/null 2>&1; then
                      echo "PR already open."
                    else
                      gh pr create \
                        --base main \
                        --head devel \
                        --title "Merge devel into main" \
                        --body "Automated PR (created after successful R-CMD-check on devel)"
                    fi

                    # enable auto-merge (squash here; change if you prefer)
                    gh pr merge --auto --squash "$(gh pr list --base main --head devel --state open --json number --jq '.[0].number')"
                  else
                    echo "devel is not ahead of main. Nothing to do."
                  fi
